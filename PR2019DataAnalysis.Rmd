---
title: "Puerto Rico 2019 Soil and Root Analyses by Depth"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float:
      collapsed: TRUE
      smooth_scroll: no
  pdf_document:
    toc: yes
  fig_caption: yes
  tab_caption: yes
---

# Introduction
The current model includes roots and 10 soil layers (as defined by hydrological models ) up to 3 m. However, the behavior of roots within those layers and how they regulate P acquisition is not well constrained. One study found (citation?) that root phosphatase decreased with depth but actually increased by depth when root phosphatase is expressed per root length. Measuring root physical and physiological traits along a defined soil profile will enable a more complete understanding of root interactions with soil phosphorus availability across depths, providing data needed to parameterize the phosphorus model.  

# Methods

## Sample Collection and Processing
On February 22nd - February 24th, 2019 we collected three soil cores per site up to a meter for soil phosphatase and bulk density. Soil phosphatase cores will also be processed for resin P and root biomass. Bulk density samples will also be processed for total P and organic P. We collected soil phosphatase cores using a 30 cm split core with a hammer and collected bulk density cores using a kit. We also collected a 30 cm core for paired root and soil phosphatase.

We returned 2/26/2019 and samples were to arrive on 2/27/2019. However, they arrived late on 2/28/2019.

**Root and soil phosphatase: 2/28/2019 - 03/02/2019**

Root and soil phosphatase was measured using a modified para-nitrophenyl phosphatase method. Approximately 0.5 g fresh wt of roots in 9 mls of 50 mM sodium acetate-acetic acid buffer was incubated for 1 hr in 200 rpm at 27 $^\circ$C. Absorbance of the solution when terminated with 0.11 M NaOH was read at 400 nm and compared to a blank. Soil phosphatase was measured in a similar process except 1.0 g fresh soil was used with modified universal buffer. In addition, soil samples were terminated with 0.5 M NaOH and 0.5 M CaCl2.

**Mycorrhizae: 2/28/2019 - 03/01/2019**

**Bulk density: 2/28/2019 - 03/03/2019**
Bulk density samples were collected using a kit from AMR to ensure consistency. The diameter of each metal rings containing the soil was (**2.54 cm??**). Soil was removed from the metal rings and deposited into bulk density bags and oven dried at (110 $^\circ$C).

**Resin P: 03/01/2019 - 03/04/2019**
Resin P was measuring using anion exchange membrane strips charged with sodium bicarbonate. Approximately 8 g fresh wt of soil and five strips were added to a sample cups with 80 mls diH2O and shaken vigorously (rpm) for 24 hours. Membrane strips were removed and washed with diH2O prior to shaking them with 50 ml of 0.25 M H2SO4 for 1 hr at lower speed. Phosphate concentration was measuring using the Lachat Quikchem.

**Root picking for root biomass: 03/10/2019 - 03/26/2019**
Roots from each depth: 0-5 cm, 7-12 cm, 12-14cm, 20-26cm, 33-47cm, and 58-88cm were picked for both transportive (> 1 mm diameter) and absorptive (< 1 mm diameter) roots.

**Organic P: 4/15/2019 - 4/19/2019**
Total soil organic phosphorus was measured using the Bowman extraction method, modified in Condron 1990. Briefly, 2 g of fresh soil was measured into a 50 ml falcon tube prior to adding 3 ml of 18 M H2SO4 added 1 ml at a time. 4 mls of diH2O was added in 1 ml increments followed by 48 mls of diH2O. Samples were vortexed in between each addition to ensure complete contact between acid, water, and soil. Samples were centrifuged then filtered. The filter was saved and added to the soil following the acid extraction for hte alkali extraction. Both the filter and the soil was shaken with 98 ml of 0.5 M NaOH for 2 hours. After centrifuging and filtering, both the acid extract and the alkali extract were read using the Lachat.
**EVR organic P analysis needs to be redone**

## Statistical analysis
For consistency, data are rank transformed prior to using two-way ANOVAs to discern differences among sites and depth.

## To-do list

- graph organic p (& resin p) x sand:silt:clay
- combine depths to use for paired root&soil phosphatase and re-analyze
- multifactor analysis for soil phosphatase instead of pca
- fix depths so that they're consistent between graphs

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r Packages}
library(tidyverse)
library(car)
library(reshape2)
library(plotrix)
library(knitr)
library(factoextra)
library(naniar)
library(ggpubr)
```

```{r MasterSheet}
mastersheet <- read.csv("~/Documents/Stats/PR2019/Mastersheet.csv", header = TRUE, stringsAsFactors = TRUE, na.strings = "NA")
str(mastersheet)
```


# Soil Phosphatase
Soil phosphatase decreases with depth consistently among all sites,. Contrary to our hypothesis, soil phosphatase activity in ICA-R and ICA-V were lower than El Verde sites, despite previous results indicating much lower levels of available phosphorus. Interestingly, when ICA-R and ICA-V are combined as they were in a previous study, we see the same trend, where Icacos has higher phosphatase activity than EVR and EVV. In addition, previous results have suggested that Valley sites have lower phosphatase activity, perhaps due to surface runoff of phosphorus. However, here the differences between Ridge and Valley sites are not pronounced.

```{r Data Import}
soilpase <- read.csv("~/Documents/Stats/PR2019/SoilPase.csv", header = TRUE, na.strings = "NA", stringsAsFactors = TRUE)
View(soilpase)
```

```{r Supplementary Figure 1}
# boxplot of soil pase by depth and site
ggplot(data = soilpase, aes(x = Depth, y = SoilPase)) + geom_boxplot() + geom_point() +
  facet_grid(. ~ Site) + scale_x_discrete(limits=c("0-5cm", "7-12cm", "15-20cm", "25-30cm", "45-50cm", "80-90cm")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        axis.title.x = element_blank()) +
  ylab(expression(Soil~Phosphatase~(mu~pNP~g^{-1})))
```

## Summary Statistics
```{r Soil Pase mean}
# soil pase by site and depth
soilpase.sum <- soilpase %>%
  group_by(Site, Depth) %>%
  summarise(n = n(),
            mean = mean(SoilPase, na.rm = TRUE),
            sd = sd(SoilPase, na.rm = TRUE),
            se = ((sd(SoilPase, na.rm = TRUE))/sqrt(n())))
write.csv(soilpase.sum, "table_soilpase_sitedepth.csv")

# soil pase by site
soilpase.sum2 <- soilpase %>%
  group_by(Site) %>%
  summarise(n = n(),
            mean = mean(SoilPase, na.rm = TRUE),
            sd = sd(SoilPase, na.rm = TRUE),
            se = ((sd(SoilPase, na.rm = TRUE))/sqrt(n())))
write.csv(soilpase.sum2, "table_soilpase_site.csv")
View(soilpase.sum2)

# soil pase barplot by site
soilpase_bar <- ggplot(data = soilpase.sum2, aes(x = Site, y = mean)) +
  geom_bar(stat = "identity", colour = "black") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), width = 0.2) +
  scale_y_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank()) +
  ylab(expression(Mean~soil~phosphatase~(mu~mol~pNP~gsoil^{-1})))

pdf("plot_soilpase_bar.pdf")
plot(soilpase_bar)
dev.off()


```

```{r Soil pase point}
soilpase.sum$Depth = factor(soilpase.sum$Depth, levels = c('0-5cm', '7-12cm', '15-20cm', '25-30cm', '45-50cm', '80-90cm'))

soilpase_point <- ggplot(data = soilpase.sum, aes(x = Depth, y = mean, colour = Site, group = Site)) + geom_point(size = 3) + geom_line(na.rm = FALSE) +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = c(0.9, 0.8)) +
  scale_colour_brewer(palette = "Set2") +
  xlab(expression(Soil~depth~(cm))) +
  ylab(expression(Mean~soil~phosphatase~(mu~mol~pNP~g~soil^{-1})))

pdf("plot_soilpase_point.pdf")
plot(soilpase_point)
dev.off()
```

## ANOVA
```{r Supplementary Table 2}
pase.rank <- rank(soilpase$SoilPase)
soilpase <- cbind(soilpase, pase.rank)

soilpase.aov <- aov(pase.rank ~ Site + Depth + Site:Depth, data = soilpase)
summary(soilpase.aov)
TukeyHSD(soilpase.aov)

options(max.print = 10000000)
sink(file = "posthoc.txt")
TukeyHSD(soilpase.aov)
sink(NULL) # add letters

```

## Combined Icacos Plot
```{r Combined Icacos}
soilpase.mod <- read.csv("~/Documents/LabStats/PR2019/PR2019_PaseMod.csv", header = TRUE, na.strings = "NA", stringsAsFactors = TRUE)

pase.mod.sum <- soilpase.mod %>%
  group_by(Site, Depth) %>%
  summarise(n = n(),
            mean = mean(Pase, na.rm = TRUE),
            sd = sd(Pase, na.rm = TRUE),
            se = ((sd(Pase, na.rm = TRUE))/sqrt(n())))

ggplot(data = pase.mod.sum, aes(x = Depth, y = mean)) + geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), width = 0.2) + coord_flip() +
  facet_grid(. ~ Site) +
  scale_x_discrete(limits = rev(c("0-5cm", "7-12cm", "14-19cm", "27-32cm", "47-52cm", "87-92cm"))) +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.title.y = element_blank()) +  ylab(expression(Mean~Soil~Phosphatase~(mu~mol~pNP~g^{-1})))
```

# Paired Root and Soil Phosphatase
Root and soil phosphatase was analyzed using a two-way repeated measures MaNOVA to determine whether phopshatase activity depended on whether it was measured from roots or soil and to discern differences in activity by site and depth. Root phosphatase and soil phosphatase, when standardized to soil volume were drastically different, with greater soil phsophatase than root phosphatase. Both differed among sites (p < 0.05), but not by depth (p = 0.98).

```{r Data Import Paired}
pairedpase <- read.csv("~/Documents/Stats/PR2019/ShortCore.csv", header = TRUE, na.strings = "NA", stringsAsFactors = TRUE)
View(pairedpase)
```

```{r Paired Boxplot}
# root pase per g root
ggplot(data = pairedpase, aes(x = Site, y = rootpase_groot, fill = Depth)) + geom_boxplot() +
  scale_y_continuous(limits = c(0, 200), breaks = c(0, 25, 50, 75, 100, 125, 150, 175, 200)) +
  scale_x_discrete(breaks = c("EVR", "EVV", "ICA-R", "ICA-V"),
                   labels = c("El Verde Ridge", "El Verde Valley", "Icacos-Ridge", "Icacos-Valley")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = c(0.9,0.8),
        legend.background = element_rect(colour = "black"),
        axis.title.x = element_blank()) +
  scale_fill_brewer(palette = "Greys") + ylab(expression(Phosphatase~(mu~mol~pNP~g^{-1}root)))

# soil pase per g soil
ggplot(data = pairedpase, aes(x = Site, y = soilpase_gsoil, fill = Depth)) + geom_boxplot() +
  scale_x_discrete(breaks = c("EVR", "EVV", "ICA-R", "ICA-V"),
                   labels = c("El Verde Ridge", "El Verde Valley", "Icacos-Ridge", "Icacos-Valley")) +
  scale_y_continuous(limits = c(0, 12), breaks = c(0, 2, 4, 6, 8, 10, 12)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = c(0.9,0.8),
        legend.background = element_rect(colour = "black"),
        axis.title.x = element_blank()) +
  scale_fill_brewer(palette = "Greys") + ylab(expression(Phosphatase~(mu~mol~pNP~g^{-1}soil)))
```

```{r Paired by volume}
# root pase by volume
paired.rootvol<- ggplot(data = pairedpase, aes(x = Site, y = rootpase_vol, fill = Depth)) + geom_boxplot() +
   scale_x_discrete(breaks = c("EVR", "EVV", "ICA-R", "ICA-V"),
                   labels = c("El Verde Ridge", "El Verde Valley", "Icacos-Ridge", "Icacos-Valley")) +
  scale_y_continuous(limits = c(0, 0.5), breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = c(0.8,0.8),
        legend.background = element_rect(colour = "black"),
        axis.title.x = element_blank()) +
  scale_fill_brewer(palette = "Greys") +
  ylab(expression(Root~Phosphatase~(mu~mol~pNP~cm^{-3}~soil)))

pdf("plot_paired_rootvol.pdf")
plot(paired.rootvol)
dev.off()

# soil pase by volume
paired_soilvol <- ggplot(data = pairedpase, aes(x = Site, y = soilpase_vol, fill = Depth)) + geom_boxplot() +
   scale_x_discrete(breaks = c("EVR", "EVV", "ICA-R", "ICA-V"),
                   labels = c("El Verde Ridge", "El Verde Valley", "Icacos-Ridge", "Icacos-Valley")) +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = c(0.8,0.8),
        legend.background = element_rect(colour = "black"),
        axis.title.x = element_blank()) +
  scale_fill_brewer(palette = "Greys") +
  ylab(expression(Phosphatase~(mu~mol~pNP~cm^{-3}~soil)))

pdf("plot_paired_soilvol.pdf")
plot(paired_soilvol)
dev.off()
```

```{r Paired mean tables}

#paired by site and depth
pairedpase.sum <- pairedpase %>%
  dplyr::select(Site, Depth, rootpase_groot, rootpase_vol, soilpase_gsoil, soilpase_vol) %>%
  group_by(Site, Depth) %>%
  summarise_all(funs(mean, sd), na.rm = TRUE)
write.csv(pairedpase.sum, "table_pairedpase_sitedepth.csv")

# paired pase by site
pairedpase.sum2 <- pairedpase %>%
  select(Site, rootpase_groot, rootpase_vol, soilpase_gsoil, soilpase_vol) %>%
  group_by(Site) %>%
  summarise_all(funs(mean, sd), na.rm = TRUE)
write.csv(pairedpase.sum2, "table_pairedpase_site.csv")
View(pairedpase.sum2)
```

## Two-way repeated measures MANOVA
```{r Supplementary Table 4}

# setting up dataframe for volume
pairedpase.manova <- pairedpase %>%
  dplyr::select(Site, Depth, rootpase_vol, soilpase_vol) %>%
  melt(id = c("Site", "Depth"))
View(pairedpase.manova)

# rank transforming data
pase.rank <- rank(pairedpase.manova$value)
pairedpase.manova <- cbind(pairedpase.manova, pase.rank)

ID <- rownames(pairedpase.manova)
pairedpase.manova <- cbind(id=ID, pairedpase.manova)

# establishing factors
pairedpase.manova <- within(pairedpase.manova, {
  Site <- factor(Site)
  Depth <- factor(Depth)
  variable <- factor(variable)
})

# ANOVA
pairedmanova.aov <- with(pairedpase.manova,
               aov(pase.rank ~ variable*Site*Depth + Error(id / (Site*Depth))))
summary(pairedmanova.aov)

# re-run as two way anova with site and variable as  factor
paired.aov <- aov(pase.rank ~ variable*Site, data = pairedpase.manova)
summary(paired.aov)
TukeyHSD(paired.aov)
```


# Resin P
An outlier test using Cooks Distance indicates that sample 19 (EVV Location 1: 0-5 cm) is a data point that significantly skews statistical models. In this case, sample 19 is 4 times the mean, suggesting that it should not be included. Phosphorus availability differed among sites (p < 0.001), but not by depth. Generally, El Verde sites contained more phosphorus than in Icacos sites and there weren't any consistent patterns of phosphorus availability by depth.

```{r Data Import ResinP}
resinp <- read.csv("~/Documents/Stats/PR2019/PR2019_resinp.csv", header = TRUE, na.strings = "NA", stringsAsFactors = TRUE)
View(resinp)
```

## Outlier Test
```{r Resin P Outlier}
# outlier test: Cook's D
mod <- lm(ResinP ~ Site, data = resinp)
cooksd <- cooks.distance(mod)

# plot Cook's D using 4/n
plot(cooksd, pch = "*", cex = 2, main = "Influential Obs by Cooks distance")
abline(h = 4/70, col="red")
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4/70, names(cooksd),""), col="red")

# replacing 19 (EVV Location 1 0-5cm)
resinp <- resinp %>%
  replace_with_na(replace = list(ResinP = 5.71))
```

## Summary Statistics
```{r Resin P boxplot}
ggplot(data = resinp, aes(x = SoilDepth, y = ResinP)) + geom_boxplot() + facet_grid(.~Site) +
  scale_x_discrete(limits = c("0-5cm", "7-12cm", "14-19cm", "27-32cm", "47-52cm", "87-92cm")) +
  scale_y_continuous(limits = c(0, 2.00)) +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
                     axis.title.x = element_blank()) +
  ylab(expression(Phosphorus~availability~(mu~g~P~g^{-1})))
```

```{r Supplementary Table 5}
# resin p by site and depth
resinp.sum <- resinp %>%
  group_by(Site, SoilDepth) %>%
  summarise(n = n(),
            mean = mean(ResinP, na.rm = TRUE),
            sd = sd(ResinP, na.rm = TRUE),
            se = std.error(ResinP, na.rm = TRUE))
write.csv(resinp.sum, "table_resinp_sitedepth.csv")

# resin p mean by site
resinp.sum2 <- resinp %>%
  group_by(Site) %>%
  summarise(n = n(),
            mean = mean(ResinP, na.rm = TRUE),
            sd = sd(ResinP, na.rm = TRUE),
            se = std.error(ResinP, na.rm = TRUE))
write.csv(resinp.sum2, "table_resinp_site.csv")

# resin p by site barplot
resinpsum.plot <- ggplot(data = resinp.sum2, aes(x = Site, y = mean)) + geom_bar(stat = "identity", colour = "black") +
  geom_errorbar(aes(ymax = mean+se, ymin = mean-se), width = 0.2) +
  scale_y_continuous(limits = c(0, 1.00)) +
  scale_colour_brewer(palette = "Set2") +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.text.x = element_text(hjust = 1, vjust = 1),
                     axis.title.x = element_blank()) +
  ylab(expression(Resin~P~(mu~g~P~g^{-1})))

pdf("plot_resinp_bar.pdf")
plot(resinpsum.plot)
dev.off()
```

```{r Figure 3}

# geom_point resin p
resinp.point <- ggplot(data = resinp.sum, aes(x = SoilDepth, y = mean, colour = Site, group = Site)) +
  geom_point(size = 3) +
  geom_line(na.rm = FALSE) +
  scale_y_continuous(limits = c(0, 1.00)) +
  scale_colour_brewer(palette = "Set2") +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.text.x = element_text(hjust = 1, vjust = 1),
                     axis.title.x = element_blank(),
                     legend.position = c(0.9,0.8)) +
  ylab(expression(Phosphorus~availability~(mu~g~P~g^{-1})))

pdf("plot_resinp_point.pdf")
plot(resinp.point)
dev.off()

```

## ANOVA
```{r Supplementary Table 6}
rank.resin <- rank(resinp$ResinP)
resinp <- cbind(resinp, rank.resin)

rank.resin.aov <- aov(rank.resin ~ Site*SoilDepth, data = resinp)
summary(rank.resin.aov)
TukeyHSD(rank.resin.aov)
```

# Normality
```{r}
ggqqplot(resinp$ResinP)
shapiro.test(resinp$ResinP) # non-normal
```


# Organic P
Unlike resin P, there are stark differences in organic phosphorus content among the sites (p < 0.001) and depths (p < 0.01). In particular, both El Verde sites have significantly higher concentrations than in the Icacos sites. There was no significant interaction between site and depth in determining organic phosphorus, and the boxplot suggests that organic phosphorus tends to decrease until 25-30 cm before increasing slightly.
**double check with re-done values**

```{r Organic P Data Import}
orgp <- read.csv("~/Documents/Stats/PR2019/OrganicP.csv", header = TRUE, stringsAsFactors = TRUE, na.strings = "NA")
View(orgp)
```

## Summary Statistics
```{r Organic P boxplot}
# organic P by depth and site
ggplot(data = orgp, aes(x = Depth, y = Total)) + geom_boxplot() +
  facet_grid(.~Site) + scale_x_discrete(limits = c("0 -5 cm", "7-12 cm", "15-20 cm", "25-30 cm", "45-50 cm", "80-90 cm")) + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        axis.title.x = element_blank()) +
  ylab(expression(Total~organic~P~(mg~P~g^{-1})))
```

```{r Organic P mean table}
# Total organic P by site and depth
orgp.sum <- orgp %>%
  group_by(Site, Depth) %>%
  summarise(n = n(),
            mean = mean(Total, na.rm = TRUE),
            sd = sd(Total, na.rm = TRUE),
            se = std.error(Total, na.rm = TRUE))
write.csv(orgp.sum, "orgp_sum.csv")

# total organic P by site
orgp.sum2 <- orgp %>%
  group_by(Site) %>%
  summarise(n = n(),
            mean = mean(Total, na.rm = TRUE),
            sd = sd(Total, na.rm = TRUE),
            se = std.error(Total, na.rm = TRUE))
write.csv(orgp.sum2, "orgp_sum_site.csv")
View(orgp.sum2)

```

```{r Organic P summary plots}
orgp.sum$Depth <- factor(orgp.sum$Depth, levels = c('0 -5 cm', '7-12 cm', '15-20 cm', '25-30 cm', '45-50 cm', '80-90 cm'))

# point
orgp.point <- ggplot(data = orgp.sum, aes(x = Depth, y = mean, colour = Site, group = Site)) +
  geom_point(size = 3) +
  geom_line(na.rm = FALSE) +
  scale_y_continuous(limits = c(0, 1.00)) +
  scale_colour_brewer(palette = "Set2") +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.text.x = element_text(hjust = 1, vjust = 1),
                     axis.title.x = element_blank(),
                     legend.position = c(0.9,0.75)) +
  ylab(expression(Phosphorus~availability~(mu~g~P~g^{-1})))

pdf("resinp.pdf")
plot(resinp.point)
dev.off()

# bar
orgp.bar <- ggplot(data = orgp.sum2, aes(x = Site, y = mean)) +
  geom_bar(stat = "identity", colour = "black") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), width = 0.2) +
  scale_y_continuous(limits = c(0, 0.3)) +
  theme_bw() + theme(panel.grid = element_blank(),
                     axis.title.x = element_blank()) +
  ylab(expression(Mean~total~organic~P~(mg~P~g^{-1})))

pdf("orgp_bar.pdf")
plot(orgp.bar)
dev.off()

```

## ANOVA
```{r Supplementary Table 8}
# rank transform
rank.optotal <- rank(orgp$Total)
orgp <- cbind(orgp, rank.optotal)

rank.orgp.aov <- aov(rank.optotal ~ Site*Depth, data = orgp)
summary(rank.orgp.aov) # significant
TukeyHSD(rank.orgp.aov)

library(lsmeans)
library(car)
model.rankorgp <- lm(rank.optotal ~ Site + Depth + Site:Depth, data = orgp)
Anova(model.rankorgp, type = "II") # exactly the same as aov

lsmeans(model.rankorgp,
        pairwise ~ Site,
        adjust = "tukey")

lsmeans(model.rankorgp,
        pairwise ~ Depth,
        adjust = "tukey")
```

# Normality
```{r}
ggqqplot(orgp$organicp_vol)
shapiro.test(orgp$organicp_vol) # not normal
```

# Correlations
## Resin P x Soil Phosphatase
The relationship between resin P and soil phosphatase depends on site and depth. As depth increases, the separation among sites diminishes until after 27-32 cm where there is no differenc among sites in soil phosphtase and resin P availability. In general, the Icacos sites tend to have lower soil phosphatase and resin P availability, within each depth. Given similar levels of phosphorus, El Verde sites consistently have higher soil phosphatase activity.

```{r corr resin p x soilpase}
pase.corr <- cbind(soilpase, resinp$ResinP)
pase.corr <- pase.corr %>%
  select(Site, Location, Depth, Parent, SoilPase, 'resinp$ResinP')
View(pase.corr)

pase.corr$Depth = factor(pase.corr$Depth, levels = c('0-5cm', '7-12cm', '15-20cm', '25-30cm', '45-50cm', '80-90cm'))

ggplot(data = pase.corr, aes(x = resinp$ResinP, y = SoilPase)) +
  geom_point(aes(shape = Site, fill = Depth), alpha = 0.5, size=5) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme(panel.grid = element_blank()) + xlab(expression(Phosphorus~availability~(mu~P~gsoil^{-1}))) +
  ylab(expression(Soil~Phosphatase~(mu~pNP~gsoil^{-1})))

# ellipse
library(ggpubr)
ggscatter(pase.corr, x = "resinp$ResinP", y = "SoilPase",
          color = "Parent", shape = "Parent",
          ellipse = TRUE)

# producing the legend
corr.legend <- ggplot(data = pase.corr, aes(x = resinp$ResinP, y = SoilPase, shape = Site, color = Depth)) +
  geom_point(alpha = 0.5, size=5) +
  scale_color_brewer(palette = "Set2")

pdf("corr_legend.pdf")
plot(corr.legend)
dev.off()


```
Source: http://r-statistics.co/Linear-Regression.html => recheck this

```{r Vol corr resinp x pase}
resinp.vol <- read.csv("~/Documents/Stats/PR2019/PR2019_resinp_vol.csv", header = TRUE, stringsAsFactors = TRUE, na.strings = "NA")
View(resinp.vol)

resinp.vol <- resinp.vol %>%
  select(SampleID, BD, resinp_vol)

resinp.pase.vol <- cbind(resinp.vol, soilpase)
resinp.pase.vol <- resinp.pase.vol %>%
  select(SampleID, Site, Depth, BD, resinp_vol, SoilPase_vol)
View(resinp.pase.vol)

resinp.pase.vol$Depth = factor(resinp.pase.vol$Depth, levels = c('0-5cm', '7-12cm', '15-20cm', '25-30cm', '45-50cm', '80-90cm'))

corr.resinp.pase <- ggplot(data = resinp.pase.vol, aes(x = resinp_vol, y = SoilPase_vol)) +
  geom_point(aes(shape = Site, fill = Depth), alpha = 0.5, size=5) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme(panel.grid = element_blank()) +
  xlab(expression(Phosphorus~availability~(mu~P~cm^{-3}))) +
  ylab(expression(Soil~Phosphatase~(mu~pNP~cm^{-3})))

pdf("corr_resinp_pase.pdf")
plot(corr.resinp.pase)
dev.off()

# outlier test: Cook's D
mod <- lm(resinp_vol ~ SoilPase_vol, data = resinp.pase.vol)
cooksd <- cooks.distance(mod)

# plot Cook's D using 4/n
plot(cooksd, pch = "*", cex = 2, main = "Influential Obs by Cooks distance")
abline(h = 4/70, col="red")
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4/70, names(cooksd),""), col="red")

# replacing 19 (EVV Location 1 0-5cm)
library(naniar)
str(resinp.pase.vol)
resinp.pase.vol <- resinp.pase.vol %>%
  replace_with_na(replace = list(resinp_vol = 6.368))

# equation
cor(resinp.pase.vol$resinp_vol, resinp.pase.vol$SoilPase_vol, use = "complete.obs") # 0.079

lm.mod <- lm(SoilPase_vol ~ resinp_vol, data = resinp.pase.vol)
print(lm.mod)
summary(lm.mod)

```

## Organic P x Resin P
```{r organic P x resin P}
View(mastersheet)

org.resin <- mastersheet %>% 
  select(Site, Depth, Parent, ResinP_vol, Organicp_vol)
View(org.resin)

# note: manually fixed outlier, see previous code 

# plot
org.resin$Depth = factor(org.resin$Depth, levels = c('0 -5 cm', '7-12 cm', '15-20 cm', '25-30 cm', '45-50 cm', '80-90 cm'))

corr.orgp.resinp <- ggplot(data = org.resin, aes(x = Organicp_vol, y = ResinP_vol)) +
  geom_point(aes(shape = Site, fill = Depth), alpha = 0.5, size = 4) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_x_continuous(limits = c(0, 0.30), breaks = c(0.00, 0.10, 0.20, 0.30)) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)) +
  theme(panel.grid = element_blank()) +
  xlab(expression(Total~Organic~Phosphorus~(mg~P~cm^{-3}))) +
  ylab(expression(Resin~P~(mu~g~P~cm^{-3})))

pdf("corr_orgp_resinp.pdf")
plot(corr.orgp.resinp)
dev.off()

# parent material
ggscatter(org.resin, x = "Organicp_vol", y = "ResinP_vol",
          color = "Parent", shape = "Parent",
          ellipse = TRUE)

# NOTE: tested normality. both x and y are non-normal
# non parametric
cor(orgp.resinp$organicp_vol, orgp.resinp$resinp_vol, method = "spearman", use = "complete.obs") # 0.61

# linear model
orgp.resinp.mod <- lm(ResinP_vol ~ Organicp_vol, data = org.resin)
coefficients(orgp.resinp.mod) # same as print()
summary(orgp.resinp.mod)$r.squared # 0.269; multiple r squared what is difference between that and adjustred r squared
# also gives p value which is < 0.05 so there is a relatiomship 

plot(orgp.resinp.mod) # residuals look okay

```

## Organic P x Soil Phosphatase
The relationship between organic P and soil phosphatase mirrors that of resin P, where soil phosphatase and organic phosphorus consistently decline with depth and the differences between sites disappear after 25-30 cm in depth. For a given organic phosphorus concentration, there is generally higher soil phosphatase in El Verde Ridge. El Verde Valley and Icacos Ridge appear to have similar soil phosphatase activity, despite Icacos Ridge having consistently lower amounts of organic phosphorus. Icacos Valley tends to have both lower organic phosphorus content and soil phosphtatase.

```{r Figure 6}
# binding soil phosphatase data
soilpase2 <- soilpase %>%
  select(SoilPase, SoilPase_vol)
orgp.pase <- cbind(orgp, soilpase2)
View(orgp.pase)

orgp.pase$Depth = factor(orgp.pase$Depth, levels = c("0 -5 cm", "7-12 cm", "15-20 cm", "25-30 cm", "45-50 cm", "80-90 cm"))

corr.orgp.pase <- ggplot(data = orgp.pase, aes(x = organicp_vol, y = SoilPase_vol)) +
  geom_point(aes(shape = Site, fill = Depth), alpha = 0.5, size = 4) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_x_continuous(limits = c(0, 0.30), breaks = c(0.00, 0.10, 0.20, 0.30)) +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme(panel.grid = element_blank()) +
  xlab(expression(Total~Organic~Phosphorus~(mg~P~cm^{-3}))) +
  ylab(expression(Soil~Phosphatase~(mu~mol~pnp~cm^{-3})))

pdf("corr_orgp_pase.pdf")
plot(corr.orgp.pase)
dev.off()

# ellipse
ggscatter(orgp.pase, x = "organicp_vol", y = "SoilPase_vol",
          color = "Parent", shape = "Parent",
          ellipse = TRUE)

# getting equation
cor(orgp.pase$organicp_vol, orgp.pase$SoilPase_vol, use = "complete.obs") # 0.166

# linear model
lm.mod3 <- lm(SoilPase_vol ~ organicp_vol, data = orgp.pase)
print(lm.mod3)
summary(lm.mod3)
```

## Root Biomass x Root Phosphatase
As expected, root biomass decreass with depth. Root biomass does not appear ot differ significantly among sites, consistently remaing within 0.001 g/cm3 - 0.002 g/cm3. However, soil phosphatase varies among sites, where despite similar amounts of root biomass;  El Verde Ridge is highest in soil phosphatase activity, followed by El Verde Valley and Icacos Ridge, with Icacos Valley having the lowest amounts.

Note: removed 5-7cm data because no corresponding resin p or phosphatase activity

```{r Figure 7}
biom.corr <- read.csv("~/Documents/Stats/PR2019/BiomassCorrelations.csv", header = TRUE, stringsAsFactors = TRUE, na.strings = "NA")
View(biom.corr)

biom.corr$ResinPaseTrueDepth = factor(biom.corr$ResinPaseTrueDepth, levels = c("0-5cm", "7-12cm", "15-20cm", "25-30cm", "45-50cm", "80-90cm"))

corr.rootmass.pase <- ggplot(data = biom.corr, aes(x = RootBiomass, y = SoilPase_vol)) +
  geom_point(aes(shape = Site, fill = ResinPaseTrueDepth), alpha = 0.5, size = 5) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_x_continuous(limits = c(0.000, 0.0025), breaks = c(0.000, 0.001, 0.002, 0.0025)) +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme(panel.grid = element_blank()) +
  xlab(expression(Root~Biomass~(g~root~cm^{-3}))) +
  ylab(expression(Soil~Phosphatase~(mu~mol~pnp~cm^{-3})))

pdf("corr_rootmass_pase.pdf")
plot(corr.rootmass.pase)
dev.off()

# ellipse
ggscatter(biom.corr, x = "RootBiomass", y = "SoilPase_vol",
          color = "Parent", shape = "Parent",
          ellipse = TRUE)

# getting equation
cor(biom.corr$RootBiomass, biom.corr$SoilPase_vol, use = "complete.obs")
# 0.313

# linear model
lm.mod4 <- lm(SoilPase_vol ~ RootBiomass, data = biom.corr)
print(lm.mod4)
summary(lm.mod4)
```

## Bulk density x soil pase
```{r}
setwd("~/Documents/Stats/PR2019/")
View(mastersheet)
mastersheet$Depth = factor(mastersheet$Depth, levels = c("0 -5 cm", "7-12 cm", "15-20 cm", "25-30 cm", "45-50 cm", "80-90 cm"))

corr.bulkdens.pase <- ggplot(data = mastersheet, aes(x = BulkDens, y = SoilPase_vol)) +
  geom_point(aes(shape = Site, fill = Depth), alpha = 0.5, size = 4) + scale_fill_brewer(palette = "Set2") +
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  geom_smooth(method = lm, se = FALSE, color = "black") +
  theme_bw() +
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  theme(panel.grid = element_blank()) +
  xlab(expression(Bulk~density~(g~cm^{-3}))) +
  ylab(expression(Soil~Phosphatase~(mu~mol~pnp~cm^{-3})))

pdf("corr_bulkdens_pase.pdf")
plot(corr.bulkdens.pase)
dev.off()

# ellipse
ggscatter(mastersheet, x = "BulkDens", y = "SoilPase_vol",
          color = "Parent", shape = "Parent",
          ellipse = TRUE)

# getting correlation
cor(mastersheet$BulkDens, mastersheet$SoilPase_vol, use = "complete.obs") # - 0.22

# linear model
mod.bulkdens.pase <- lm(SoilPase_vol ~ BulkDens, data = mastersheet)
print(mod.bulkdens.pase)
summary(mod.bulkdens.pase)
```

# Regression Analysis
```{r}
mastersheet <- read.csv("~/Documents/Stats/PR2019/Mastersheet.csv", header = TRUE, stringsAsFactors = TRUE, na.strings = "NA")
View(mastersheet)
str(mastersheet)

fit1 <- lm(SoilPase_vol ~ BulkDens + ResinP_vol + Organicp_vol + RootBiomass + Parent, data = mastersheet) # try stepwise?
summary(fit1)
coefficients(fit1)
anova(fit1)

```

# NMDS
Not really all that useful
```{r}
View(mastersheet) 

# merging sample number and site and depth
mstest <- unite(mastersheet, ID, c(SampleNumber, Site, Depth), remove = FALSE)

# fixing row names
rownames(mstest) <- mstest[,1]
mstest <- mstest[,-1]

library(magrittr)
library(MASS)

# computing MDS
mds <- mstest %>% 
  dist() %>% 
  isoMDS() %>%
  .$points %>% 
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# plot
ggscatter(mds, x = "Dim.1", y = "Dim.2",
          label = rownames(mstest),
          size = 1,
          repel = TRUE)

# k-means clustering
clust <- kmeans(mds, 3)$cluster %>% 
  as.factor()

mds <- mds %>% 
  mutate(groups = clust)

ggscatter(mds, x = "Dim.1", y = "Dim.2",
          label = rownames(mstest),
          color = "groups",
          size = 1,
          ellipse = TRUE,
          repel = TRUE)
```

# PCA
```{r}
library(factoextra)
View(mstest)
ms.all <- mstest %>% 
  dplyr::select(Site, Depth, Parent, BulkDens, SoilPase_vol, ResinP_vol, Organicp_vol, RootBiomass)
ms.all <- ms.all[complete.cases(ms.all), ]
View(ms.all)

ms.quant <- ms.all %>% 
  dplyr::select(BulkDens, SoilPase_vol, ResinP_vol, Organicp_vol, RootBiomass)
View(ms.quant)

# computing PCA
res.pca <- prcomp(ms.quant, scale = TRUE)

# eigenvalues (% of variances explained by each PC)
fviz_eig(res.pca)

# graph of individuals
fviz_pca_ind(res.pca, 
             col.ind = "cos2", # quality of representation
             repel = TRUE)

# graph of variables
fviz_pca_var(res.pca,
             col.var = "contrib", # color by contribution to PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

# biplot of variables and individuals - merge
fviz_pca_biplot(res.pca, repel = TRUE,
                col.var = "contrib",
                gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                col.ind = "#696969",
                label = "var"
                )

# coloring by group - merge
groups <- as.factor(ms.all$Parent[1:66]) 
fviz_pca_ind(res.pca,
             col.ind = ms.all$Parent,
             palette = c("#00AFBB",  "#FC4E07"),
             addEllipses = TRUE,
             ellipse.type = "confidence",
             legend.title = "Parent Material",
             repel = TRUE,
             label = "none")
# colors for site: c("#00AFBB",  "#FC4E07", "#696969", "#E7B800")
# pca info
var <- get_pca_var(res.pca) # getting results for variables

# quality of variable representation ( high cos2 = good representation)
head(var$cos2)

# contribution of variables to PCs
# variables that are correlated wtih PC1 and 2 are most important to explaining variation
head(var$contrib) # larger contirbution = best

# contributions of variables to PC1
fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)

```
